<!-- Place here your css styles -->
<link rel="stylesheet" href="/css/shopping.css"/>
<link rel="web icon" type="png" href="images/webicon.png">
<!-- Body -->

<!--Navigation Bar-->
<nav>
    <a href="/">
        <div class="logo">
            <h1>Rental <span> Hub</span></h1>
        </div>
    </a>
    
    <div class="search-wrapper">
        <input type="search" id="search" placeholder="Search for items" class="search-input"/>
        <button id="search-button"><img src="/images/search.png"/></button>
    </div>
    

    <ul>
        <li><a href="/">Home</a></li>
        <li>
            <% if (isAuthenticated && role === 'admin' ) { %>
                <a href="/admin/listing">
                    <img src="/images/blueAdd.png" class="add-icon"/>
                </a>
            <% } else if (isAuthenticated && role === 'user' ) { %>
                <a href="/user/listing">
                    <img src="/images/blueAdd.png" class="add-icon"/>
                </a>
            <% } else { %>
            <% } %>
        </li>
        <li>
            <% if (isAuthenticated && role === 'admin' ) { %>
                <a href='/admin/admin-dashboard'>
                    <img src="/images/blueProfile.png" alt="Profile" class="profile-icon"/>
                </a>
            <% } else if (isAuthenticated && role === 'user' ) { %>
                <a href='/user/profile'>
                    <img src="/images/blueProfile.png" alt="Profile" class="profile-icon"/>
                </a>
            <% } else { %>
                <a href="/login">
                    <img src="/images/blueProfile.png" alt="Profile" class="profile-icon"/>
                </a>
            <% } %>
        </li>
    </ul>
</nav>

<!-- Categories -->
<div class="categories-cont">
    <button class="category active" onclick="openCategory('events-and-parties')">
        Events & Parties
    </button>

    <button class="category" onclick="openCategory('tech-and-gadgets')">
        Tech & Gadgets
    </button>

    <button class="category" onclick="openCategory('clothing-and-accessories')">
        Clothing & Accessories
    </button>

    <button class="category" onclick="openCategory('sports-and-outdoor-gear')">
        Sports & Outdoor Gear
    </button>

    <button class="category" onclick="openCategory('tools-and-equipment')">
        Tools & Equipment
    </button>

    <button class="category" onclick="openCategory('musical-instruments')">
        Musical Instruments
    </button>

    <button class="category" onclick="openCategory('home-and-office')">
        Home & Office
    </button>

    <button class="category" onclick="openCategory('pets-accessories')">
        Pets Accessories
    </button>
</div>

<!-- Tabs -->
<div id="shopping-container"></div>


<!--Scripts-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search");
    const searchButton = document.getElementById("search-button");
    const shoppingContainer = document.getElementById("shopping-container");
    const category = window.location.pathname.split("/").pop(); 

    async function fetchItems(searchQuery = "") {
        try {
            const response = await fetch(`/api/shared/items/${getCategoryId(category)}?keyword=${(searchQuery)}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            shoppingContainer.innerHTML = "";

            if (data.success && data.data.length > 0) {
                displayItems(data.data);

                if (searchQuery) {
                    const resultCount = data.data.length;
                    const searchMessage = document.createElement("div");
                    searchMessage.className = "search-results-message";
                    searchMessage.innerHTML = `<p>Showing ${resultCount} result${resultCount !== 1 ? 's' : ''} for "${searchQuery}"</p>`;

                    // Clear Search Button
                    const clearButton = document.createElement("button");
                    clearButton.className = "clear-search";
                    clearButton.innerText = "Clear Search";
                    clearButton.addEventListener("click", function () {
                        searchInput.value = "";
                        fetchItems("");
                    });

                    searchMessage.appendChild(clearButton);
                    shoppingContainer.insertBefore(searchMessage, shoppingContainer.firstChild);
                }
            } else {
                shoppingContainer.innerHTML = `<p>No items found matching your search.</p>`;
            }
        } catch (error) {
            console.error("Error fetching data:", error);
            shoppingContainer.innerHTML = "<p>Error loading items. Please try again later.</p>";
        }
}


    function displayItems(items) {
    shoppingContainer.innerHTML = ""; 
    
    if (!items.length) {
        shoppingContainer.innerHTML = "<p>No items found matching your search.</p>";
        return;
    }

    let shoppingList = document.createElement("ul");
    shoppingList.className = "shoppingList";

    items.forEach(item => {
        if (item.quantity <= 0) return;

        console.log("Search result item:", item);

        let li = document.createElement("li");
        li.className = "shoppingItem";
        li.innerHTML = `
            <img src="${item.image}" alt="Item Image" class="itemImage">
            <br>
            <hr>
            <strong>${item.name}</strong>
            <br><br>
            <div class="item-price-quantity">
                <strong>‚Ç± ${item.price} per day</strong>
                <br>
                <p class="item-quantity"> ${item.quantity} left</p>
            </div>
            <br>
            üìç: ${item.location}
            <br>
        `;

        li.addEventListener("click", function () {
            localStorage.setItem("selectedItem", JSON.stringify(item));
            window.location.href = `/user/view-product/${item.id}`;
        });

        shoppingList.appendChild(li);
    });

    shoppingContainer.appendChild(shoppingList);
}

    let debounceTimer;
    searchInput.addEventListener("input", function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            fetchItems(this.value.trim());
        }, 100); 
    });

    searchButton.addEventListener("click", function() {
        fetchItems(searchInput.value.trim());
    });

    searchInput.addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
            fetchItems(this.value.trim());
        }
    });

    fetchItems();
});


    // Tabs Functionality
    function openCategory(categoryName) {
        // Redirect to the category page with the path
        window.location.href = `/shopping/${categoryName}`;
    }

    // Set the active category based on URL path
    document.addEventListener("DOMContentLoaded", function () {
        const path = window.location.pathname;
        const category = path.split("/").pop();

        if (category) {
            // Hide all shoppingContainers
            document.querySelectorAll(".shoppingContainer").forEach((container) => {
                container.style.display = "none";
            });

            // Show the selected category container
            const selectedContainer = document.getElementById(category);
            if (selectedContainer) {
                selectedContainer.style.display = "block";
            } else {
                console.error(`No element found with ID: ${category}`);
            }

            // Remove active class from all buttons
            document.querySelectorAll(".category").forEach((button) => {
                button.classList.remove("active");
            });

            // Add active class to the button corresponding to the category
            const activeButton = document.querySelector(`.category[onclick="openCategory('${category}')"]`);
            if (activeButton) {
                activeButton.classList.add("active");
            } else {
                console.error(`No button found for category: ${category}`);
            }
        } else {
            // Default to the first category if no category is specified
            const defaultCategory = document.querySelector(".category").getAttribute("onclick").match(/'([^']+)'/)[1];
            openCategory(defaultCategory);
        }
    });


    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("event-and-parties").style.display = "block";

    });


    //home to shopping
    document.addEventListener("DOMContentLoaded", function () {
        // Get the URL parameters
        const params = new URLSearchParams(window.location.search);
        const category = params.get("category");

        if (category) {
            // Hide all shoppingContainers
            document
                .querySelectorAll(".shoppingContainer")
                .forEach((container) => {
                    container.style.display = "none";
                });

            // Show the selected category container
            const selectedContainer = document.getElementById(category);
            if (selectedContainer) {
                selectedContainer.style.display = "block";
            }
        }
    });

    function getCategoryId(categoryValue) {
    let category = categoryValue
    let categoryId = 1;

    switch (category) {
        case "events-and-parties":
            categoryId = 1;
            break;
        case "tech-and-gadgets":
            categoryId = 2;
            break;
        case "clothing-and-accessories":
            categoryId = 3;
            break;
        case "sports-and-outdoor-gear":
            categoryId = 4;
            break;
        case "tools-and-equipment":
            categoryId = 5;
            break;
        case "musical-instruments":
            categoryId = 6;
            break;
        case "home-and-office":
            categoryId = 7;
            break;
        case "pets-accessories":
            categoryId = 8;
            break;
    }
    return categoryId;
}
</script>
<script src="/js/get-category-id.js"></script>